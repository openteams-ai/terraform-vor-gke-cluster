name: "Terraform Static Checks"

on:
  push:
    branches: [ "main"]
  pull_request:
    branches: [ "main"]
  workflow_dispatch:

jobs:
  terraform-lint-secure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: "~1.5"

      - name: Setup Python for Checkov
        uses: actions/setup-python@v5.6.0
        with:
          python-version: '3.11'

      - name: Cache Security Tools
        uses: actions/cache@v4.2.3
        with:
          path: |
            ~/.local/bin
            ~/.cache/pip
          key: security-tools-${{ runner.os }}-v1

      - name: Install Security Tools
        run: |
          # Install tflint
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          # Install checkov
          pip install --user checkov

          # Add tools to PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Terraform Format Check
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive -diff .
          if [ $? -ne 0 ]; then
            echo "âŒ Terraform files are not properly formatted"
            echo "ðŸ’¡ Run 'terraform fmt -recursive' to fix formatting issues"
            exit 1
          fi
          echo "âœ… All Terraform files are properly formatted"

      - name: Terraform Validate
        run: |
          echo "ðŸ” Validating Terraform configuration..."

          # Validate root module
          terraform init -backend=false
          terraform validate

          # Validate examples
          for example in examples/*/; do
            if [ -d "$example" ]; then
              echo "ðŸ” Validating example: $example"
              cd "$example"
              terraform init -backend=false
              terraform validate
              cd - > /dev/null
            fi
          done

          echo "âœ… All Terraform configurations are valid"

      - name: Setup TFLint Config
        run: |
          cat > .tflint.hcl << EOF
          plugin "terraform" {
            enabled = true
            preset  = "recommended"
          }

          plugin "google" {
            enabled = true
            version = "0.25.0"
            source  = "github.com/terraform-linters/tflint-ruleset-google"
          }

          rule "terraform_required_providers" {
            enabled = true
          }

          rule "terraform_required_version" {
            enabled = true
          }

          rule "terraform_naming_convention" {
            enabled = true
          }

          rule "terraform_documented_variables" {
            enabled = true
          }

          rule "terraform_documented_outputs" {
            enabled = true
          }
          EOF

      - name: Run TFLint
        run: |
          echo "ðŸ” Running TFLint checks..."
          tflint --init
          tflint --format=compact
          echo "âœ… TFLint checks completed"

      - name: Run TFSec Security Scan
        run: |
          echo "ðŸ” Running TFSec security scan..."
          tfsec . \
            --format=json \
            --out=tfsec-results.json \
            --soft-fail

          # Also output human-readable format
          tfsec . --format=lovely
          echo "âœ… TFSec security scan completed"

      - name: Run Checkov Security Scan
        run: |
          echo "ðŸ” Running Checkov security scan..."
          checkov -d . \
            --framework terraform \
            --output json \
            --output-file checkov-results.json \
            --soft-fail

          # Also output human-readable format
          checkov -d . \
            --framework terraform \
            --compact \
            --quiet
          echo "âœ… Checkov security scan completed"

      - name: Upload Security Scan Results
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3.1.3
        if: always()
        with:
          name: security-scan-results
          path: |
            tfsec-results.json
            checkov-results.json
          retention-days: 30

      - name: Test Examples
        run: |
          echo "ðŸ” Testing example configurations..."

          for example in examples/*/; do
            if [ -d "$example" ]; then
              echo "ðŸ§ª Testing example: $example"
              cd "$example"

              # Check if terraform.tfvars.example exists
              if [ -f "terraform.tfvars.example" ]; then
                cp terraform.tfvars.example terraform.tfvars
              fi

              # Test terraform plan (without applying)
              terraform init -backend=false
              terraform plan -out=plan.tfplan

              echo "âœ… Example $example validated successfully"
              cd - > /dev/null
            fi
          done

      - name: Generate Security Report Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "tfsec-results.json" ]; then
            TFSEC_ISSUES=$(jq '.results | length' tfsec-results.json 2>/dev/null || echo "0")
            echo "**TFSec:** $TFSEC_ISSUES issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "checkov-results.json" ]; then
            CHECKOV_FAILED=$(jq '.summary.failed' checkov-results.json 2>/dev/null || echo "0")
            CHECKOV_PASSED=$(jq '.summary.passed' checkov-results.json 2>/dev/null || echo "0")
            echo "**Checkov:** $CHECKOV_FAILED failed, $CHECKOV_PASSED passed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Detailed results are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
